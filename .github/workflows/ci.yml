name: CI

on:
  push:
  pull_request:

jobs:
  cpp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure
        run: cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
      - name: Build
        run: cmake --build build -j
      - name: Test
        run: ctest --test-dir build --output-on-failure
      - name: Perf Smoke
        run: |
          mkdir -p docs/results
          python3 scripts/perf/run_hotpath_bench.py \
            --benchmark-bin build/hotpath_benchmark \
            --baseline configs/perf/baseline.json \
            --result-json docs/results/hotpath_bench_result.json

  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
      - name: Lint + Type + Tests
        run: |
          ruff check python scripts
          black --check python scripts
          mypy python/quant_hft
          python scripts/build/verify_contract_sync.py
          python scripts/build/verify_develop_requirements.py
          pytest python/tests -q
      - name: Backtest Benchmark Data Prep + Gate
        run: |
          mkdir -p runtime/benchmarks/backtest docs/results
          python scripts/perf/prepare_backtest_benchmark_data.py \
            --input-csv backtest_data/rb.csv \
            --output-csv runtime/benchmarks/backtest/rb_ci_sample.csv \
            --max-ticks 1200 \
            --report-json docs/results/backtest_benchmark_data_report.json
          python scripts/perf/run_backtest_benchmark.py \
            --csv-path runtime/benchmarks/backtest/rb_ci_sample.csv \
            --baseline configs/perf/backtest_benchmark_baseline.json \
            --result-json docs/results/backtest_benchmark_result.json
      - name: Ops Smoke
        run: |
          mkdir -p runtime docs/results
          python scripts/ops/fake_redis_bridge_server.py --host 127.0.0.1 --port 16379 > runtime/fake_redis.log 2>&1 &
          FAKE_REDIS_PID=$!
          trap "kill ${FAKE_REDIS_PID}" EXIT
          sleep 1
          QUANT_HFT_REDIS_HOST=127.0.0.1 QUANT_HFT_REDIS_PORT=16379 \
          python scripts/ops/run_reconnect_evidence.py \
            --dry-run \
            --skip-preflight \
            --probe-bin /bin/echo \
            --config configs/sim/ctp.yaml \
            --scenarios disconnect \
            --strategy-bridge-chain-status auto \
            --report-file docs/results/reconnect_fault_result.md \
            --health-json-file docs/results/ops_health_report.json \
            --health-markdown-file docs/results/ops_health_report.md | tee runtime/ops_smoke.out
          grep -q -- "--strategy-bridge-chain-status complete" runtime/ops_smoke.out
          grep -q -- "--strategy-bridge-chain-source auto_detected" runtime/ops_smoke.out
          grep -q -- "--strategy-bridge-state-key-count 2" runtime/ops_smoke.out
          grep -q -- "--strategy-bridge-intent-count 1" runtime/ops_smoke.out
          grep -q -- "--strategy-bridge-order-key-count 1" runtime/ops_smoke.out
          python scripts/ops/failover_orchestrator.py \
            --env-config configs/deploy/environments/prodlike_multi_host.yaml \
            --output-file docs/results/failover_result.env
          python scripts/ops/verify_failover_evidence.py \
            --evidence-file docs/results/failover_result.env \
            --max-failover-seconds 300 \
            --max-data-lag-events 0
          test -f docs/results/ops_alert_report.json
          test -f docs/results/ops_alert_report.md
          test -f docs/results/failover_result.env
          grep -q "quant_hft_strategy_bridge_chain_integrity" docs/results/ops_health_report.md
      - name: Upload Ops Smoke Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ops-smoke-artifacts
          path: |
            runtime/fake_redis.log
            runtime/ops_smoke.out
            docs/results/reconnect_fault_result.md
            docs/results/ops_health_report.json
            docs/results/ops_health_report.md
            docs/results/ops_alert_report.json
            docs/results/ops_alert_report.md
            docs/results/failover_result.env
          if-no-files-found: error
          retention-days: 14
