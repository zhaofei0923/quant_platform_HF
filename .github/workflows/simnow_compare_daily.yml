name: SimNow Compare Daily

on:
  workflow_dispatch:
  schedule:
    - cron: "20 22 * * 1-5"

jobs:
  compare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure + Build
        run: |
          cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
          cmake --build build -j
      - name: Dependency Audit
        run: bash scripts/build/dependency_audit.sh --build-dir build
      - name: Repo Purity Check
        run: bash scripts/build/repo_purity_check.sh --repo-root .
      - name: Run SimNow Compare
        run: |
          mkdir -p docs/results
          mkdir -p runtime/benchmarks/backtest
          CSV_PATH=runtime/benchmarks/backtest/rb_ci_sample.csv
          if [[ ! -f "${CSV_PATH}" ]]; then
            cat >"${CSV_PATH}" <<'CSV'
symbol,exchange,ts_ns,last_price,last_volume,bid_price1,bid_volume1,ask_price1,ask_volume1,volume,turnover,open_interest
rb2405,SHFE,1704067200000000000,100.0,1,99.9,5,100.1,5,10,1000,100
rb2405,SHFE,1704067201000000000,101.0,1,100.9,5,101.1,5,11,1111,100
rb2405,SHFE,1704067202000000000,99.0,1,98.9,5,99.1,5,12,1188,100
rb2405,SHFE,1704067203000000000,102.0,1,101.9,5,102.1,5,13,1326,100
CSV
          fi
          ./build/simnow_compare_cli \
            --config configs/sim/ctp.yaml \
            --csv_path "${CSV_PATH}" \
            --run_id "simnow-daily" \
            --output_json docs/results/simnow_compare_report.json
      - name: Upload compare artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simnow-compare-report
          path: docs/results/simnow_compare_report.json
          if-no-files-found: warn
          retention-days: 14
