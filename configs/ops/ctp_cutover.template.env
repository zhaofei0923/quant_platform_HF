# CTP one-shot cutover template
# Fill all commands with your production-safe command lines before execution.
# Field dictionary: docs/ops/config_catalog.md (`configs/ops/ctp_cutover.template.env`)
# Notes:
#   1) 所有 *_CMD 需保持幂等并可重复执行。
#   2) 涉及 kill/start 的命令必须在演练环境先验证。

CUTOVER_ENV_NAME=single-host-ubuntu
CUTOVER_WINDOW_LOCAL=2026-02-13T09:00:00+08:00
CTP_CONFIG_PATH=configs/prod/ctp.yaml

OLD_CORE_ENGINE_STOP_CMD=bash -lc 'if [[ -f /tmp/quant_hft_core_engine.pid ]]; then pid=$(cat /tmp/quant_hft_core_engine.pid); kill "$pid" 2>/dev/null || true; rm -f /tmp/quant_hft_core_engine.pid; fi; true'

BOOTSTRAP_INFRA_CMD=bash scripts/infra/bootstrap_prodlike.sh --profile single-host --compose-file infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env --execute --output-file docs/results/single_host_bootstrap_result.env
INIT_KAFKA_TOPIC_CMD=bash scripts/infra/init_kafka_topics.sh --compose-file infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env --execute --output-file docs/results/kafka_topic_init_result.env
INIT_CLICKHOUSE_SCHEMA_CMD=bash scripts/infra/init_clickhouse_schema.sh --compose-file infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env --execute --output-file docs/results/clickhouse_schema_init_result.env
INIT_DEBEZIUM_CONNECTOR_CMD=bash scripts/infra/init_debezium_connectors.sh --connect-url http://localhost:8083 --execute --output-file docs/results/debezium_connector_init_result.env

NEW_CORE_ENGINE_START_CMD=bash -lc 'nohup ./build/core_engine configs/prod/ctp.yaml >/tmp/quant_hft_core_engine.log 2>&1 & echo $! >/tmp/quant_hft_core_engine.pid'

PRECHECK_CMD=bash -lc './build/reconnect_evidence_cli --report_file docs/results/reconnect_fault_result.md --health_json_file docs/results/ops_health_report.json --health_markdown_file docs/results/ops_health_report.md --alert_json_file docs/results/ops_alert_report.json --alert_markdown_file docs/results/ops_alert_report.md --strategy-engine-chain-status complete --strategy-engine-chain-source in_process --strategy-engine-state-key-count 2 --strategy-engine-intent-count 1 --strategy-engine-order-key-count 1 --storage-redis-health healthy --storage-timescale-health healthy'
WARMUP_QUERY_CMD=bash -lc 'sleep 1; if [[ -f /tmp/quant_hft_core_engine.pid ]]; then kill -0 $(cat /tmp/quant_hft_core_engine.pid) >/dev/null 2>&1 || true; fi; true'

POST_SWITCH_MONITOR_MINUTES=30
MONITOR_KEYS=order_latency_p99_ms,breaker_state,query_rate_violation,reconnect_p99_s,kafka_lag_ms,clickhouse_ingest_delay_ms

CUTOVER_EVIDENCE_OUTPUT=docs/results/ctp_cutover_result.env
