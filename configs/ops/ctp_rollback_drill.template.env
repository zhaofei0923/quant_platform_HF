# CTP rollback drill template
# Fill all commands with your production-safe command lines before execution.
# Field dictionary: docs/ops/config_catalog.md (`configs/ops/ctp_rollback_drill.template.env`)
# Notes:
#   1) 回滚命令与切换命令需一一对应。
#   2) MAX_ROLLBACK_SECONDS 用于演练超时失败判定。

ROLLBACK_ENV_NAME=single-host-ubuntu
ROLLBACK_TRIGGER_CONDITION=order_latency_p99_ms_gt_5ms_or_reconnect_p99_s_gt_10s

NEW_CORE_ENGINE_STOP_CMD=bash -lc 'if [[ -f /tmp/quant_hft_core_engine.pid ]]; then pid=$(cat /tmp/quant_hft_core_engine.pid); kill "$pid" 2>/dev/null || true; rm -f /tmp/quant_hft_core_engine.pid; fi; true'

RESTORE_PREVIOUS_BINARIES_CMD=bash -lc 'echo wsl-single-host: skip binary restore workspace deployment'
RESTORE_STRATEGY_ENGINE_COMPAT_CMD=bash -lc 'echo wsl-single-host: strategy engine compat is in-process and no-op'

PREVIOUS_CORE_ENGINE_START_CMD=bash -lc 'nohup ./build/core_engine configs/prod/ctp.yaml >/tmp/quant_hft_core_engine.log 2>&1 & echo $! >/tmp/quant_hft_core_engine.pid'

POST_ROLLBACK_VALIDATE_CMD=bash -lc './build/reconnect_evidence_cli --report_file docs/results/reconnect_fault_result.md --health_json_file docs/results/ops_health_report.json --health_markdown_file docs/results/ops_health_report.md --alert_json_file docs/results/ops_alert_report.json --alert_markdown_file docs/results/ops_alert_report.md --strategy-engine-chain-status complete --strategy-engine-chain-source in_process --strategy-engine-state-key-count 2 --strategy-engine-intent-count 1 --strategy-engine-order-key-count 1 --storage-redis-health healthy --storage-timescale-health healthy'

MAX_ROLLBACK_SECONDS=180
ROLLBACK_EVIDENCE_OUTPUT=docs/results/ctp_rollback_result.env
