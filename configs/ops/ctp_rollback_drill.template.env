# CTP rollback drill template
# Fill all commands with your production-safe command lines before execution.

ROLLBACK_ENV_NAME=single-host-ubuntu
ROLLBACK_TRIGGER_CONDITION=order_latency_p99_ms_gt_5ms_or_reconnect_p99_s_gt_10s

NEW_CORE_ENGINE_STOP_CMD=bash -lc 'if [[ -f /tmp/quant_hft_core_engine.pid ]]; then pid=$(cat /tmp/quant_hft_core_engine.pid); kill "$pid" 2>/dev/null || true; rm -f /tmp/quant_hft_core_engine.pid; fi; true'
NEW_STRATEGY_RUNNER_STOP_CMD=bash -lc 'if [[ -f /tmp/quant_hft_strategy_runner.pid ]]; then pid=$(cat /tmp/quant_hft_strategy_runner.pid); kill "$pid" 2>/dev/null || true; rm -f /tmp/quant_hft_strategy_runner.pid; fi; true'

RESTORE_PREVIOUS_BINARIES_CMD=bash -lc 'echo wsl-single-host: skip binary restore workspace deployment'
RESTORE_REDIS_BRIDGE_COMPAT_CMD=bash -lc 'echo wsl-single-host: redis bridge compat is optional in direct mode'

PREVIOUS_CORE_ENGINE_START_CMD=bash -lc 'nohup ./build/core_engine configs/prod/ctp.yaml >/tmp/quant_hft_core_engine.log 2>&1 & echo $! >/tmp/quant_hft_core_engine.pid'
PREVIOUS_STRATEGY_RUNNER_START_CMD=bash -lc 'PYTHONPATH=python nohup python3 scripts/strategy/run_strategy.py --config configs/prod/ctp.yaml >/tmp/quant_hft_strategy_runner_legacy.log 2>&1 & echo $! >/tmp/quant_hft_strategy_runner.pid'

POST_ROLLBACK_VALIDATE_CMD=python3 scripts/ops/run_ctp_readiness_evidence.py --output-json docs/results/ctp_readiness_rollback.json --environment single-host-ubuntu --query-latency-ms 1200 --flow-control-hits 1 --disconnect-recovery-success-rate 1.0 --reject-classified-ratio 1.0 --core-process-alive true --redis-health healthy --timescale-health healthy --strategy-bridge-chain-status complete

MAX_ROLLBACK_SECONDS=180
ROLLBACK_EVIDENCE_OUTPUT=docs/results/ctp_rollback_result.env
