# 未完成能力补齐路线图

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地
- 证据路径：`develop/`、`src/`、`python/`、`scripts/`、`.github/workflows/ci.yml`
- 最后更新：2026-02-11

## 1. 说明

本路线图用于承接 `develop/` 中“已落地（仓库范围）但仍有外部依赖边界”的能力缺口。目标是把“文档差异”转成可执行工程任务，不在本文件内直接声明任何新功能已上线。
当前生产环境推进策略为分阶段执行：先完成单机生产 SLA 基线，再推进多机备份与跨主机容灾。

## 2. 优先级与迭代顺序

1. `P0` 文档真实性与可执行性收敛：先保证开发者不会误判现状。
2. `P1` 能力闭环补齐：研究平台 MVP + 执行/风控增强。
3. `P2` 单机生产运维与可观测性：在前两步稳定后推进。
4. `P3` 多机备份与容灾：在 `P2` 稳定通过后推进。

推荐迭代：`P0 -> Epic A -> Epic B -> Epic C -> Epic D(single-host) -> Epic E(multi-host)`。

## 当前 Sprint（滚动执行）

- 当前 Sprint：`D11`（双周）
- 状态：`done`
- 本期已完成：
  1. 新增仓库内 prodlike 依赖栈编排资产：
     - `infra/docker-compose.prodlike.yaml`
     - `infra/prometheus/prometheus.yml`
     - `infra/alertmanager/alertmanager.yml`
     - `infra/loki/loki-config.yml`
     - `infra/tempo/tempo.yml`
     - `infra/grafana/provisioning/datasources/datasources.yml`
     - `infra/env/prodlike.env`
  2. 新增一键入口与健康检查脚本：
     - `scripts/infra/bootstrap_prodlike.sh`
     - `scripts/infra/check_prodlike_health.py`
  3. 新增机器校验测试：
     - `python/tests/test_bootstrap_prodlike_script.py`
     - `python/tests/test_check_prodlike_health_script.py`
     - `python/tests/test_prodlike_infra_assets.py`
  4. 新增正式证据：
     - `docs/results/prodlike_bootstrap_result.env`
     - `docs/results/prodlike_health_report.json`

## 最新批次（M8 文档收敛）

- 批次：`M8`
- 状态：`done`
- 本批已完成：
  1. `scripts/build/verify_develop_requirements.py` 增加文档完成语义门禁（`--forbidden-term`、`--develop-root`、`--completion-language-report`）。
  2. 新增/更新校验测试：`python/tests/test_verify_develop_requirements_script.py`。
  3. 收敛 `develop/` 专题文档中的未完成语义表述，统一为“已落地（仓库范围）+ 扩展能力”描述。
  4. 产出文档完成语义证据：
     - `docs/results/develop_completion_language_report.json`

## 下一阶段执行口径（生产环境）

1. `M9`（当前优先）：单机生产基线验收
   - 目标：在单台 PC 或云上单实例主机完成“部署 -> 故障注入 -> 回滚 -> 恢复 -> 证据归档”闭环。
   - 交付：单机主机清单、环境参数模板、演练证据、SLA 基线记录。
2. `M10`（后续批次）：多机备份与容灾增强
   - 目标：实现跨主机备份、主备切换与容灾演练编排。
   - 交付：多机拓扑、切换脚本、跨主机验收证据、恢复时限报告。

完成标记规则（强制）：
- `done`：代码 + 测试 + develop 文档状态同步全部完成。
- `blocked`：阻塞超过 1 个工作日且已记录原因与恢复条件。
- `in_progress`：其余进行中状态。

## 3. Epic A（P1）：策略研究平台 MVP

- 状态：`done`（MVP 范围）

### 当前已实现
- `quant_hft.backtest.replay` 回放框架与脚本入口。
- `StrategyBase` / `StrategyRuntime` 基础策略运行时。
- `scripts/backtest/replay_csv.py` 可执行回放。
- `BacktestRunSpec/BacktestRunResult` 及 `--spec-file/--report-json/--run-id` 闭环。
- 策略输出合约校验与 backtest 必备上下文字段固定（`ctx` 必备键）。

### 最小增量目标
- 统一研究数据接口（研究输入与实盘合约一致）。
- 补齐可复用回测场景模板与结果报告结构。
- 建立“研究参数 -> 回测结果 -> 复现实验”最小闭环。

### 涉及目录
- `python/quant_hft/backtest/`
- `python/quant_hft/strategy/`
- `scripts/backtest/`
- `develop/02-策略研究平台设计/`

### 测试与验收
- `python/tests/test_backtest_replay.py`、`python/tests/test_backtest_scenarios.py` 通过。
- 新增至少 1 个固定数据样例可重复产出同一指标结果。
- `./scripts/build/bootstrap.sh` 通过。
- 当前判定：已满足（见 `docs/IMPLEMENTATION_PROGRESS.md` A1-A9）。

### 风险与前置依赖
- 依赖稳定样本数据与统一合约定义。
- 指标定义需先冻结，避免频繁变更导致结果不可比。

## 4. Epic B（P1）：高级风控与执行算法

### 当前已实现
- 风控规则组：`BasicRiskEngine`（账户/品种/时段匹配 + 默认回退）。
- 风控决策元数据：`rule_group/rule_version/decision_ts_ns`。
- 订单执行模式：`direct|sliced`（配置驱动）。
- 订单超时撤单：`cancel_after_ms` + `cancel_check_interval_ms`（轮询策略，`0` 表示关闭）。
- 基础订单生命周期：`OrderStateMachine`（含 sliced 订单并行状态迁移）。
- 策略桥接闭环：Redis state/intent/order_event。

### 最小增量目标
- 增加可配置风控规则组（品种/时段/账户维度）。
- 增加执行策略层（切片、撤改单策略）并保留当前状态机兼容。
- 对关键决策（放行/拒绝）补齐结构化审计字段。

### 涉及目录
- `src/services/risk/`
- `src/services/order/`
- `src/apps/core_engine_main.cpp`
- `include/quant_hft/contracts/types.h`

### 测试与验收
- 新增风险规则单测与执行策略单测。
- 回放场景中可复现“放行/拒绝/撤改”路径。
- `ctest --test-dir build` 与 `./scripts/build/bootstrap.sh` 全绿。

### 风险与前置依赖
- 需要先冻结订单事件字段，避免 Python runner 回调破坏兼容。
- 需要明确账户与交易所规则来源，避免硬编码分叉。

## 5. Epic C（P2）：可观测性与告警全栈

### 当前已实现
- 运维脚本：监控/重连证据收集类工具。
- Ops 健康报告：`ops_health_report.json` + `ops_health_report.md`。
- 策略桥链路完整性 SLI：`strategy_bridge_chain_integrity`。
- Redis 键链自动探测：`run_reconnect_evidence.py --strategy-bridge-chain-status auto`。
- CI 模拟链路校验：`fake_redis_bridge_server.py` + ops smoke 断言。
- CI 证据工件保留：`actions/upload-artifact` 上传 `runtime/` 与 `docs/results/`。
- release bundle 自动验包：`verify_nonhotpath_release.py` + `release-package` workflow gate。
- release 审计摘要：`release_audit_summary.py` + `GITHUB_STEP_SUMMARY` + Markdown/JSON artifact 保留。
- release 审计 JSON 校验：`verify_release_audit_summary.py` + release workflow gate。
- CI 与基础质量门禁可运行（含 ops smoke）。

### 最小增量目标
- 定义统一指标命名规范与最小 SLI/SLO 集。
- 建立“核心进程健康 + 策略桥 + 存储”三段式告警基线。
- 补齐故障演练记录模板并纳入 runbook。

### 涉及目录
- `python/quant_hft/ops/`
- `scripts/ops/`
- `docs/*RUNBOOK*.md`
- `develop/04-基础设施与运维/`

### 测试与验收
- 至少 1 条端到端故障注入演练有证据输出。
- 告警规则在仿真环境可触发与恢复。
- 运维脚本在 CI smoke job 中可执行。

### 风险与前置依赖
- 依赖部署环境提供统一时间源与日志采集路径。
- 告警阈值需按真实交易负载校准。

## 6. Epic D（P2）：生产级部署/容灾/运维闭环

- 状态：`done`（当前仓库范围）
- 当前口径：`single-host production baseline`
- 后续口径：`multi-host backup & failover`

### 当前已实现
- systemd/k8s manifest 渲染脚本。
- 非热路径部署 runbook。
- 包装脚本：`scripts/build/package_nonhotpath_release.sh`（版本规则 + `release_manifest.json`）。
- 包装校验脚本：`scripts/build/verify_nonhotpath_release.py`（checksum + manifest + required-files）。
- 包装审计脚本：`scripts/build/release_audit_summary.py`（生成发布审计摘要，支持 Markdown/JSON）。
- 审计校验脚本：`scripts/build/verify_release_audit_summary.py`（校验审计 JSON 关键字段一致性）。
- WAL 演练证据校验脚本：`scripts/ops/verify_wal_recovery_evidence.py`（校验证据字段完整性与 RTO/RPO 阈值）。
- 部署回滚演练证据校验脚本：`scripts/ops/verify_deploy_rollback_evidence.py`（校验证据字段完整性与回滚时长阈值）。
- 回滚演练步骤与验证命令已纳入 `SYSTEMD/K8S/WAL` runbook。
- 实操演练正式证据已归档：
  - `docs/results/deploy_rollback_result.env`
  - `docs/results/deploy_rollback_drill.log`
  - `docs/results/wal_recovery_result.env`
  - `docs/results/wal_recovery_drill.log`
  - `docs/results/epic_d_operational_drill_report_2026-02-11.md`

### 最小增量目标
- 形成“发布包 -> 部署 -> 回滚 -> 验证”闭环流程。
- 落地 WAL 恢复演练与 RTO/RPO 实测记录。
- 将 07-02 运维手册从目标态拆为“现状 SOP + 规划 SOP”。

### 涉及目录
- `scripts/ops/`
- `scripts/build/`
- `docs/SYSTEMD_DEPLOYMENT_RUNBOOK.md`
- `docs/K8S_DEPLOYMENT_RUNBOOK.md`
- `docs/WAL_RECOVERY_RUNBOOK.md`

### 测试与验收
- 以同一版本包完成一次“部署 + 回滚”演练。
- WAL 恢复演练有完整输入/输出证据。
- 发布流程至少包含一次自动化校验（脚本或 CI）。
- 当前判定：已满足（见本节证据路径）。

### 风险与前置依赖
- 依赖外部 Redis/Timescale 可达性与凭据管理。
- 需要先明确生产环境配置托管与密钥注入方式。

## 7. 里程碑出口条件

1. 每个 Epic 完成时，必须同步更新对应 `develop/` 文档状态。
2. 所有“已落地”声明必须附真实证据路径与可执行命令。
3. 未达出口条件前，相关章节保持“已落地（仓库范围）”并显式记录外部依赖边界。
