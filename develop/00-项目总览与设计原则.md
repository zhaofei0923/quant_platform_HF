# 项目总览与设计原则

## 1. 项目愿景

**分钟级持仓期货高频交易平台**，专攻中国期货市场，为小型专业团队提供生产级量化交易解决方案。

本平台旨在构建一个兼顾性能与可维护性的高频交易系统，专注于分钟级持仓策略，在中国境内期货商品市场（上期所、大商所、郑商所、广期所、中金所等）实现稳定盈利。系统以CTP接口作为唯一交易与行情接入网关，采用平衡架构设计，在保证亚毫秒级延迟的同时，确保系统的可观测性、风控完备性和团队协作效率。

## 2. 核心设计原则

### 2.1 平衡架构：核心C++扩展 + 策略Python层

**设计决策：** 采用C++核心扩展处理高性能路径，Python层承载策略逻辑与业务编排。

**权衡分析：**
- **性能目标：** Tick处理延迟P99 < 2ms，订单吞吐 > 10万笔/秒
- **C++核心职责：** 行情解码、订单管理、风控校验、网络通信等延迟敏感操作
- **Python层职责：** 策略逻辑、信号生成、仓位管理、数据分析等业务复杂部分
- **交互机制：** PyBind11封装C++核心为Python模块，策略通过Python API调用核心功能

**技术理由：**
- C++确保低延迟与高吞吐，满足高频交易性能需求
- Python提供快速策略迭代与团队协作效率，降低开发门槛
- 通过合理的职责划分，平衡性能与开发效率

### 2.2 合规内嵌：预埋《期货和衍生品法》遵循逻辑

**设计决策：** 将监管合规要求内化为系统核心约束，而非事后检查。

**实现要点：**
- **交易权限校验：** 账户资质、产品适当性、风险等级匹配
- **交易行为约束：** 禁止异常交易、防止操纵市场、遵守交易所规则
- **信息披露机制：** 实时交易报告、持仓披露、风险提示
- **数据保存合规：** 穿透式监管数据采集与上报

**技术实现：**
- 合规规则引擎集成于风控模块，前置拦截违规交易
- 审计日志全链路追踪，支持监管检查与回溯
- 定期合规自检与报告生成自动化

### 2.3 七维状态识别：集成幻方量化高标准市场状态引擎

**设计决策：** 参考幻方量化2026-02-09市场状态识别引擎升级方案，构建AI驱动的多维市场状态识别系统。

**七维状态空间：**
1. **趋势维度：** 多时间尺度趋势识别与强度量化
2. **波动率维度：** 实时波动率测算与regime切换检测
3. **流动性维度：** 订单簿深度、买卖价差、成交活跃度
4. **情绪维度：** 市场情绪指标、新闻情感分析、社交媒体情绪
5. **季节性维度：** 日内/周内/月内/季节性模式识别
6. **技术形态维度：** 经典技术形态识别与置信度评估
7. **事件驱动维度：** 宏观经济事件、政策公告、行业新闻影响评估

**性能目标：**
- 状态识别延迟：亚微秒级（<10μs）核心计算
- 状态更新频率：Tick级实时更新（~500ms）
- 模型推理延迟：<2ms（GPU加速）

**AI驱动智能引擎：**
- 集成Transformer、LSTM等时序模型
- 在线学习与自适应调整能力
- 多因子融合与权重动态优化

## 3. 非功能性需求

### 3.1 性能指标

| 指标 | 目标值 | 测量方法 | 备注 |
|------|--------|----------|------|
| Tick处理延迟P99 | < 2ms | 从行情接收到策略信号生成 | 核心性能指标 |
| 订单往返延迟P99 | < 5ms | 从信号生成到订单确认 | 含网络传输 |
| 订单吞吐能力 | > 10万笔/秒 | 峰值压力测试 | 含风控校验 |
| 行情处理能力 | > 50万笔/秒 | 多合约并发处理 | 全市场覆盖 |
| 系统启动时间 | < 30秒 | 冷启动到就绪状态 | 含初始化检查 |

### 3.2 可用性与可靠性

**可用性目标：** 99.95%（年停机时间 < 4.38小时）

**实现策略：**
- **冗余设计：** 关键组件主备部署，自动故障切换
- **健康检查：** 实时系统健康监控，预故障预警
- **优雅降级：** 部分功能故障时保持核心交易能力
- **快速恢复：** 系统异常时<5分钟恢复交易

**穿透式监管兼容：**
- 集成datacollectforlinux-v1.2.6数据采集组件
- 实时交易数据上报，支持监管穿透检查
- 审计日志完整保存，满足5年存储要求

### 3.3 可维护性与可观测性

**小型团队友好设计：**
- **模块化架构：** 功能模块解耦，支持独立开发与测试
- **自动化部署：** CI/CD流水线，一键部署与回滚
- **完备文档：** 开发文档、API文档、运维手册完整
- **测试覆盖：** 单元测试>80%，集成测试>90%

**可观测性体系：**
- **指标监控：** Prometheus + Grafana，实时性能监控
- **分布式追踪：** Jaeger/OpenTelemetry，全链路追踪
- **日志聚合：** ELK/EFK，结构化日志与智能分析
- **告警系统：** 多级告警策略，及时风险预警

## 4. 国内期货市场适配要点

### 4.1 交易所特有规则

**交易时段管理：**
- **日盘/夜盘分离：** 独立配置与管理，支持不同策略参数
- **小节休息：** 自动识别休息时段，暂停信号生成
- **集合竞价：** 支持开盘/收盘集合竞价阶段特殊处理

**交易规则适配：**
- **涨跌停板：** 实时价格限制检查，防止无效报单
- **最小变动价位：** 价格精度自动调整
- **交易单位：** 合约乘数、最小交易手数校验

### 4.2 合约生命周期管理

**主力连续切换：**
- 自动检测主力合约切换信号
- 平滑仓位转移策略
- 历史数据连续拼接

**到期移仓处理：**
- 提前N日移仓预警
- 智能移仓策略（价差最优、流动性最佳）
- 移仓过程风险控制

**合约上市/退市：**
- 新合约自动发现与配置
- 退市合约清理与归档
- 历史数据迁移策略

### 4.3 风控制度实现

**保证金管理：**
- 实时保证金计算与监控
- 交易所保证金率动态同步
- 风险度预警与强平预防

**手续费结构：**
- **平今/平昨区分：** 自动识别持仓来源，应用正确手续费率
- **手续费优化：** 智能选择成本最优的平仓顺序
- **手续费试算：** 交易前成本预估

**持仓限额管理：**
- 交易所/客户层面限额监控
- 临近限额预警与自动停止开仓
- 限额使用率分析与优化

## 5. CTP特定设计

### 5.1 API版本与兼容性

**目标版本：** CTP v6.7.11标准版

**兼容性策略：**
- **SimNow仿真环境：** 完全兼容，支持全流程仿真测试
- **多版本支持：** 核心抽象层隔离API差异，支持平滑升级
- **故障回退：** 版本升级失败时自动回退到稳定版本

**API封装设计：**
- **异步事件驱动：** 非阻塞IO，最大化吞吐能力
- **连接池管理：** 多连接负载均衡，防止单点故障
- **会话管理：** 自动重连、会话恢复、状态同步

### 5.2 穿透式监管集成

**数据采集方案：** datacollectforlinux-v1.2.6

**集成架构：**
```
CTP API → 交易核心 → 数据采集代理 → 监管上报系统
            ↓
        本地存储（加密）
```

**实现要点：**
- **实时采集：** 交易指令、成交回报、持仓变更实时采集
- **数据安全：** 本地加密存储，传输通道加密
- **完整性校验：** 数据完整性验证，防篡改设计
- **上报重试：** 网络异常时自动重试，确保数据不丢失

### 5.3 查询流控与性能优化

**异步回调处理机制：**
- **查询请求队列：** 统一管理查询请求，防止并发冲突
- **回调分发器：** 异步回调结果分发到对应处理模块
- **超时管理：** 查询超时自动重试或失败处理

**流控策略：**
- **频率限制：** 遵守CTP API查询频率限制（如：每秒10次）
- **优先级调度：** 关键查询（如：资金查询）优先处理
- **批量查询：** 支持批量查询优化，减少API调用次数

**性能优化：**
- **本地缓存：** 频繁查询数据本地缓存（如：合约信息）
- **增量更新：** 持仓、资金等状态增量更新，减少全量查询
- **连接复用：** 同一会话内查询连接复用，减少连接开销

## 6. 技术决策与权衡分析

### 6.1 架构权衡：性能 vs 开发效率

**选择：** C++核心 + Python策略层的混合架构

**权衡分析：**
- **纯C++方案：** 性能最优（延迟<1ms），但开发效率低，团队要求高
- **纯Python方案：** 开发效率高，但性能难以满足高频需求（延迟>10ms）
- **混合方案：** 性能损失<30%，开发效率提升300%，适合小型专业团队

**量化收益：**
- 策略开发周期从2周缩短到2天
- 核心性能满足99%高频策略需求
- 团队人员技能要求从C++专家扩展到Python中级

### 6.2 合规实现：事前预防 vs 事后检查

**选择：** 合规规则内嵌于交易核心，事前预防为主

**权衡分析：**
- **事后检查方案：** 实现简单，但违规交易可能已执行，面临监管风险
- **事前预防方案：** 实现复杂，但彻底杜绝违规交易执行

**风险规避：**
- 事前预防避免监管处罚风险（单次处罚可达数百万）
- 系统设计复杂度增加15%，但风险降低99%
- 需要持续跟踪监管规则变化，维护成本增加

### 6.3 市场状态引擎：传统 vs AI驱动

**选择：** AI驱动的七维状态识别引擎

**权衡分析：**
- **传统技术指标：** 稳定性高，可解释性强，但适应市场变化能力有限
- **AI驱动方案：** 适应性强，能发现复杂模式，但可解释性差，需要大量数据

**性能对比：**
- 传统方案：识别准确率60-70%，延迟<1μs
- AI方案：识别准确率85-95%，延迟<10μs（GPU加速）

**适用场景：**
- 高频做市策略：传统方案足够，延迟要求极高
- 分钟级持仓策略：AI方案优势明显，准确率要求高

## 7. 实施路线图

### 阶段一：基础架构搭建（第1-2月）
- C++核心扩展开发与Python绑定
- CTP API封装与基本交易功能
- 基础风控模块实现

### 阶段二：核心功能完善（第3-4月）
- 七维市场状态识别引擎开发
- 高级风控与合规模块
- 回测与仿真环境搭建

### 阶段三：系统优化与集成（第5-6月）
- 性能优化与压力测试
- 可观测性体系构建
- 生产环境部署与验证

### 阶段四：策略开发与上线（第7月+）
- 策略模板开发
- 实盘模拟测试
- 逐步实盘资金接入

## 8. 成功度量标准

### 技术指标：
- Tick处理延迟P99 < 2ms（实测）
- 系统可用性 > 99.95%（月度统计）
- 策略回测运行时间 < 1小时/年

### 业务指标：
- 策略夏普比率 > 2.0
- 最大回撤 < 10%
- 年化收益率 > 30%

### 团队效率指标：
- 新策略开发周期 < 3天
- 系统故障恢复时间 < 5分钟
- 文档完备率 > 95%

---

**文档版本：** v1.0  
**最后更新：** 2026-02-10  
**负责人：** 系统架构师（首席）  
**状态：** 草案 - 待技术评审