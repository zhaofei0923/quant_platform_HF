# 实时风控体系设计

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`src/services/risk/risk_policy_engine.cpp`、`include/quant_hft/interfaces/risk_engine.h`、`tests/unit/services/risk_policy_engine_test.cpp`
- 最后更新：2026-02-11

## 本轮变更摘要（2026-02-11）

1. 新增自成交风控模块并接入主链路：
   - 代码：`include/quant_hft/services/self_trade_risk_engine.h`、`src/services/risk/self_trade_risk_engine.cpp`、`src/apps/core_engine_main.cpp`
   - 行为：下单前执行 `PreCheck`；命中阈值后从告警模式自动升级到严格拒单模式；订单终态回报会移除活动挂单。
2. 风控策略新增撤单维度与交易所维度：
   - 代码：`src/services/risk/risk_policy_engine.cpp`、`include/quant_hft/interfaces/risk_engine.h`
   - 新字段：`exchange_id`、`max_cancel_count`、`max_cancel_ratio`。
3. 生产认证链路增加硬约束：
   - 代码：`src/core/ctp/ctp_config.cpp`
   - 约束：生产模式必须 `enable_terminal_auth=true`，且 `app_id/auth_code` 非空，以确保 `ReqAuthenticate -> ReqUserLogin`。
4. 对应测试已补齐：
   - `tests/unit/services/self_trade_risk_engine_test.cpp`
   - `tests/unit/services/risk_policy_engine_test.cpp`
   - `tests/unit/core/ctp_config_test.cpp`
   - `tests/unit/core/ctp_config_loader_test.cpp`

## 当前实现边界

已落地风控能力已覆盖多层级预检查与参数重载：
- `RiskPolicyEngine::PreCheck` 对订单意图执行层级化规则校验。
- 风控结果进入 `ITimeseriesStore::AppendRiskDecision`。
- `core_engine_main` 对放行/拒绝路径均可写回订单事件。
- `IRiskEngine::ReloadPolicies/EvaluateExposure` 支持在线策略下发与跨账户敞口评估。

当前已落地：多层级风险限额、跨账户敞口聚合、在线参数下发。

## 当前规则能力（已实现）

1. 基础字段合法性与数值边界检查。
2. 与订单状态机解耦的风控接口抽象。
3. 风控决策可审计落盘（reason/rule_id/action）。

## 能力扩展与当前实现

1. 按账户/品种/时段的差异化限额体系。
2. 连续亏损与异常交易行为检测。
3. 风控参数热更新与版本追踪。

## 落地依赖条件

- 需要账户维度持仓/资金口径统一。
- 需要风险规则配置中心与审计机制。
- 需要回放场景覆盖“拒绝/放行/部分成交”。

## 扩展实施触发条件

- 新规则有明确输入字段和失败语义。
- 规则可通过单测与回放场景复现。
- 风控变更附带回滚与开关策略。
