# 订单与执行引擎设计

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`src/services/order/order_state_machine.cpp`、`src/services/order/execution_planner.cpp`、`src/services/order/execution_router.cpp`、`src/apps/core_engine_main.cpp`、`tests/unit/services/execution_planner_test.cpp`、`tests/unit/services/execution_router_test.cpp`
- 最后更新：2026-02-11

## 本轮变更摘要（2026-02-11）

1. CTP 报撤单事件映射补齐：
   - 代码：`src/core/ctp/ctp_gateway_adapter.cpp`
   - 覆盖回调：`OnRtnOrder`、`OnRtnTrade`、`OnRspOrderInsert`、`OnErrRtnOrderInsert`、`OnRspOrderAction`、`OnErrRtnOrderAction`。
   - 扩展字段：`exchange_id`、`status_msg`、`order_submit_status`、`order_ref`、`front_id`、`session_id`、`trade_id`、`event_source`。
2. 订单键体系升级为“两阶段”：
   - 代码：`src/services/order/order_state_machine.cpp`
   - 阶段一：`front_id + session_id + order_ref`
   - 阶段二：`exchange_id + exchange_order_id`
3. 持仓冻结前置到下单阶段：
   - 代码：`src/apps/core_engine_main.cpp`
   - 行为：`PlaceOrder` 前先执行 `CtpPositionLedger::RegisterOrderIntent`，失败时直接走本地拒单事件。
4. 行情归一化与会话过滤已接入执行主循环：
   - 代码：`src/apps/core_engine_main.cpp`、`src/services/market_state/bar_aggregator.cpp`
   - 作用：非交易时段过滤、夜盘日期语义保持、分钟聚合用于统一后续 `on_bar` 口径。
5. 对应测试：
   - `tests/unit/services/order_state_machine_test.cpp`
   - `tests/unit/core/ctp_gateway_adapter_test.cpp`
   - `tests/unit/services/bar_aggregator_test.cpp`

## 当前实现边界

当前已落地的是“基础订单闭环”，包含：
- `OrderStateMachine` 管理订单生命周期。
- `IOrderGateway` 负责下单和回报回调。
- `core_engine_main` 将策略意图转 `OrderIntent`，经风控后提交。
- 执行模式支持 `direct|sliced|twap|vwap_lite`，并支持基于 `cancel_after_ms` 的超时撤单轮询。
- `ExecutionRouter` 支持 route/venue 选择、冲击成本估计与拥塞反馈。

当前已落地：高级执行算法（冲击成本建模、自适应切片、多通道路由）。

## 已落地执行链路

1. `StrategyIntentInbox` 拉取 Redis 策略意图。
2. 生成 `OrderIntent`，进入 `IRiskEngine::PreCheck`。
3. 放行后进入 `OrderStateMachine` 与 `IOrderGateway::PlaceOrder`。
4. 轮询扫描超时活跃订单，触发 `CancelOrder`（可配置关闭）。
5. 订单回报写入 realtime cache + timeseries + WAL。

## 能力扩展与当前实现

1. 执行算法插件化与参数治理。
2. 多通道路由与失败重试策略。
3. 订单拥塞与流控反馈闭环（含交易所拒单自适应节流）。

## 落地依赖条件

- 先冻结 `OrderEvent` 与 `OrderIntent` 扩展字段。
- 明确执行算法与风控规则的优先级关系。
- 建立标准化成交质量评估指标。

## 扩展实施触发条件

- 每个算法都有可回测与可回滚策略。
- 关键路径新增逻辑有性能回归基线。
- 文档状态变更前需补齐对应单测。
