# 高性能基础组件设计（内存管理、网络等）

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`include/quant_hft/core/object_pool.h`、`src/core/perf/object_pool.cpp`、`src/apps/hotpath_benchmark_main.cpp`、`tests/unit/core/object_pool_test.cpp`、`scripts/perf/run_hotpath_bench.py`
- 最后更新：2026-02-11

## 本轮变更摘要（2026-02-11）

1. 新增 `BarAggregator` 作为轻量行情聚合基础组件：
   - 代码：`include/quant_hft/services/bar_aggregator.h`、`src/services/market_state/bar_aggregator.cpp`
   - 能力：分钟桶增量聚合、非交易时段过滤、夜盘跨日语义保留、`1m -> N分钟` 合成。
2. 行情标准化前置以降低下游复杂度：
   - 代码：`src/core/ctp/ctp_gateway_adapter.cpp`、`src/apps/core_engine_main.cpp`
   - 内容：清洗无效价格哨兵值、`exchange_id/trading_day/action_day` 回填、`update_millisec` 归一。
3. 查询调度与主循环协同增强：
   - 代码：`src/apps/core_engine_main.cpp`、`src/core/ctp/query_scheduler.cpp`
   - 内容：冷启动链路查询 + 周期增量查询并存，保证查询速率受控。
4. 对应测试：
   - `tests/unit/services/bar_aggregator_test.cpp`
   - `tests/unit/core/ctp_gateway_adapter_test.cpp`

## 当前实现边界

当前仓库中可归类为“基础性能组件”的已实现部分：
- `QueryScheduler`：查询限流与队列调度。
- `StorageClientPool`：Redis/Timescale 客户端池化与重试。
- `TimescaleBufferedEventStore`：后台批量刷写。
- `ObjectPool`：热点对象复用与低开销分配回收。
- `hotpath_benchmark_main` + perf smoke：基准结果落盘与回归门禁。

当前已落地：对象池与批处理优化；零拷贝网络栈与 NUMA 亲和策略以可插拔扩展接口保留。

## 能力扩展与当前实现

1. 高频内存管理策略（对象池、分配器优化）。
2. 网络 I/O 优化（批处理、协议栈调优）。
3. 压测基线平台与性能回归门禁。

## 落地依赖条件

- 先建立统一性能指标与基准测试方法。
- 明确热点路径瓶颈，避免过早优化。
- 保证优化前后业务语义一致。

## 扩展实施触发条件

- 有可量化瓶颈数据支撑。
- 优化方案配套回归与回滚路径。
- 性能收益达到预设阈值后再合并。
