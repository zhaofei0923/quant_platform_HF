# 部署、灾备与持续集成方案

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`.github/workflows/ci.yml`、`.github/workflows/release-package.yml`、`scripts/build/package_nonhotpath_release.sh`、`scripts/build/verify_nonhotpath_release.py`、`scripts/build/release_audit_summary.py`、`scripts/build/release_audit_index.py`、`scripts/build/verify_release_audit_summary.py`、`scripts/build/verify_release_audit_index.py`、`scripts/ops/verify_wal_recovery_evidence.py`、`scripts/ops/verify_deploy_rollback_evidence.py`、`scripts/ops/failover_orchestrator.py`、`scripts/ops/verify_failover_evidence.py`、`scripts/infra/bootstrap_prodlike.sh`、`scripts/infra/check_prodlike_health.py`、`scripts/infra/bootstrap_prodlike_multi_host.sh`、`scripts/infra/check_prodlike_multi_host_health.py`、`infra/docker-compose.prodlike.yaml`、`infra/docker-compose.prodlike.multi-host.yaml`、`docs/SYSTEMD_DEPLOYMENT_RUNBOOK.md`、`docs/K8S_DEPLOYMENT_RUNBOOK.md`、`docs/WAL_RECOVERY_RUNBOOK.md`、`docs/templates/DEPLOY_ROLLBACK_RESULT.md`
- 最后更新：2026-02-11

## 当前实现边界

已落地：
- CI 流程：`.github/workflows/ci.yml`（C++ + Python 质量门禁）。
- 发布流程：`.github/workflows/release-package.yml`（打包 + 自动验包 + 审计摘要 + 审计索引 + 摘要/索引双校验 + 工件上传）。
- 部署渲染：`scripts/ops/render_systemd_units.py`、`scripts/ops/render_k8s_manifests.py`。
- 仓库内 prodlike 基础设施自建入口：`infra/docker-compose.prodlike.yaml` + `scripts/infra/bootstrap_prodlike.sh` + `scripts/infra/check_prodlike_health.py`（默认 dry-run，`--execute` 显式执行）。
- 交付打包、验包与审计摘要：`scripts/build/package_nonhotpath_release.sh`、`scripts/build/verify_nonhotpath_release.py`、`scripts/build/release_audit_summary.py`、`scripts/build/release_audit_index.py`、`scripts/build/verify_release_audit_summary.py`、`scripts/build/verify_release_audit_index.py`。
- WAL 恢复演练证据校验：`scripts/ops/verify_wal_recovery_evidence.py`（按 RTO/RPO 阈值验收）。
- 部署/回滚演练证据校验：`scripts/ops/verify_deploy_rollback_evidence.py`（按回滚时长阈值与健康检查验收）。

当前生产口径（single-host）：
- 单机主机的发布、回滚、WAL 恢复、证据校验流程。
- 仓库内 prodlike 依赖栈的自建与健康检查。

后续迭代口径（multi-host）：
- 已提供跨主机主备切换演练编排入口与证据校验（dry-run 默认）。
- 多活容灾控制面作为后续增强项。

## 当前可执行流程

1. 本地/CI 构建验证：`./scripts/build/bootstrap.sh`
2. 发布包生成、校验与审计：
   - `scripts/build/package_nonhotpath_release.sh v0.2.0`
   - `python3 scripts/build/verify_nonhotpath_release.py --bundle dist/quant-hft-nonhotpath-v0.2.0.tar.gz --checksum dist/quant-hft-nonhotpath-v0.2.0.tar.gz.sha256 --expect-version v0.2.0`
   - `python3 scripts/build/release_audit_summary.py --bundle dist/quant-hft-nonhotpath-v0.2.0.tar.gz --checksum dist/quant-hft-nonhotpath-v0.2.0.tar.gz.sha256 --output docs/results/release_audit_summary.md --json-output docs/results/release_audit_summary.json`
   - `python3 scripts/build/release_audit_index.py --summary-json docs/results/release_audit_summary.json --output-jsonl docs/results/release_audit_index.jsonl`
   - `python3 scripts/build/verify_release_audit_summary.py --summary-json docs/results/release_audit_summary.json --expect-version v0.2.0`
   - `python3 scripts/build/verify_release_audit_index.py --summary-json docs/results/release_audit_summary.json --index-jsonl docs/results/release_audit_index.jsonl --expect-version v0.2.0`
3. systemd 单元渲染与部署：见 `docs/SYSTEMD_DEPLOYMENT_RUNBOOK.md`
4. k8s 非热路径部署：见 `docs/K8S_DEPLOYMENT_RUNBOOK.md`
5. prodlike 基础设施自建（仓库范围）：
   - `bash scripts/infra/bootstrap_prodlike.sh --dry-run --action up`
   - `python3 scripts/infra/check_prodlike_health.py --ps-json-file docs/results/prodlike_ps_snapshot.json --report-json docs/results/prodlike_health_report.json`
6. WAL 恢复证据校验：
   - `python3 scripts/ops/verify_wal_recovery_evidence.py --evidence-file docs/results/wal_recovery_result.env --max-rto-seconds 10 --max-rpo-events 0`
7. 部署/回滚证据校验：
   - `python3 scripts/ops/verify_deploy_rollback_evidence.py --evidence-file docs/results/deploy_rollback_result.env --max-rollback-seconds 180`
8. 多机主备切换演练（仓库范围）：
   - `bash scripts/infra/bootstrap_prodlike_multi_host.sh --dry-run --action up --output-file docs/results/prodlike_multi_host_bootstrap_result.env`
   - `python3 scripts/ops/failover_orchestrator.py --env-config configs/deploy/environments/prodlike_multi_host.yaml --output-file docs/results/failover_result.env`
   - `python3 scripts/ops/verify_failover_evidence.py --evidence-file docs/results/failover_result.env --max-failover-seconds 300 --max-data-lag-events 0`

## 扩展目录示例（可选）

以下内容为可选扩展目录示例，默认仓库不强制启用：
- `kubernetes/production`
- `helm/`
- `docker-compose.monitoring.yml`
- 面向消息系统的生产级容灾编排（例如 Kafka 级别多活）

## 生产阶段方案（执行顺序）

1. 阶段 A：单机生产基线（当前）
   - 主机形态：单台 PC 或云上单实例主机。
   - 验收标准：发布、故障注入、回滚、恢复、证据归档全流程可重复执行。
2. 阶段 B：多机备份（后续）
   - 主机形态：双机或多机主备拓扑。
   - 验收标准：主备切换可演练、数据一致性可核验、恢复时限可量化。

## 落地依赖条件

- 先冻结发布包结构与版本命名规范。
- 明确环境配置注入与密钥管理方式。
- 为关键链路建立可演练的恢复脚本与验收标准。

## 扩展实施触发条件

- 灾备目标（RPO/RTO）完成量化定义。
- 发布与回滚均可脚本化执行并验证。
- 至少完成一次“部署-故障-恢复”闭环演练。
- 单机生产基线已稳定运行并形成连续证据。
