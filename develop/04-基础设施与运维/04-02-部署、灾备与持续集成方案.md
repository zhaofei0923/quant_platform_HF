# 部署、灾备与持续集成方案

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`.github/workflows/ci.yml`、`.github/workflows/release-package.yml`、`scripts/build/package_nonhotpath_release.sh`、`scripts/build/verify_nonhotpath_release.py`、`scripts/build/release_audit_summary.py`、`scripts/build/release_audit_index.py`、`scripts/build/verify_release_audit_summary.py`、`scripts/build/verify_release_audit_index.py`、`scripts/ops/verify_wal_recovery_evidence.py`、`scripts/ops/verify_deploy_rollback_evidence.py`、`docs/SYSTEMD_DEPLOYMENT_RUNBOOK.md`、`docs/K8S_DEPLOYMENT_RUNBOOK.md`、`docs/WAL_RECOVERY_RUNBOOK.md`、`docs/templates/DEPLOY_ROLLBACK_RESULT.md`
- 最后更新：2026-02-11

## 当前实现边界

已落地：
- CI 流程：`.github/workflows/ci.yml`（C++ + Python 质量门禁）。
- 发布流程：`.github/workflows/release-package.yml`（打包 + 自动验包 + 审计摘要 + 审计索引 + 摘要/索引双校验 + 工件上传）。
- 部署渲染：`scripts/ops/render_systemd_units.py`、`scripts/ops/render_k8s_manifests.py`。
- 交付打包、验包与审计摘要：`scripts/build/package_nonhotpath_release.sh`、`scripts/build/verify_nonhotpath_release.py`、`scripts/build/release_audit_summary.py`、`scripts/build/release_audit_index.py`、`scripts/build/verify_release_audit_summary.py`、`scripts/build/verify_release_audit_index.py`。
- WAL 恢复演练证据校验：`scripts/ops/verify_wal_recovery_evidence.py`（按 RTO/RPO 阈值验收）。
- 部署/回滚演练证据校验：`scripts/ops/verify_deploy_rollback_evidence.py`（按回滚时长阈值与健康检查验收）。

未落地：
- 完整生产级灾备自动化与多环境编排平台。
- 完整发布控制面与自动化灰度回滚。

## 当前可执行流程

1. 本地/CI 构建验证：`./scripts/build/bootstrap.sh`
2. 发布包生成、校验与审计：
   - `scripts/build/package_nonhotpath_release.sh v0.2.0`
   - `python3 scripts/build/verify_nonhotpath_release.py --bundle dist/quant-hft-nonhotpath-v0.2.0.tar.gz --checksum dist/quant-hft-nonhotpath-v0.2.0.tar.gz.sha256 --expect-version v0.2.0`
   - `python3 scripts/build/release_audit_summary.py --bundle dist/quant-hft-nonhotpath-v0.2.0.tar.gz --checksum dist/quant-hft-nonhotpath-v0.2.0.tar.gz.sha256 --output docs/results/release_audit_summary.md --json-output docs/results/release_audit_summary.json`
   - `python3 scripts/build/release_audit_index.py --summary-json docs/results/release_audit_summary.json --output-jsonl docs/results/release_audit_index.jsonl`
   - `python3 scripts/build/verify_release_audit_summary.py --summary-json docs/results/release_audit_summary.json --expect-version v0.2.0`
   - `python3 scripts/build/verify_release_audit_index.py --summary-json docs/results/release_audit_summary.json --index-jsonl docs/results/release_audit_index.jsonl --expect-version v0.2.0`
3. systemd 单元渲染与部署：见 `docs/SYSTEMD_DEPLOYMENT_RUNBOOK.md`
4. k8s 非热路径部署：见 `docs/K8S_DEPLOYMENT_RUNBOOK.md`
5. WAL 恢复证据校验：
   - `python3 scripts/ops/verify_wal_recovery_evidence.py --evidence-file docs/results/wal_recovery_result.env --max-rto-seconds 10 --max-rpo-events 0`
6. 部署/回滚证据校验：
   - `python3 scripts/ops/verify_deploy_rollback_evidence.py --evidence-file docs/results/deploy_rollback_result.env --max-rollback-seconds 180`

## 规划示例（未落地）

以下内容仅作未来设计样例，当前仓库未提供可直接执行产物：
- `kubernetes/production`
- `helm/`
- `docker-compose.monitoring.yml`
- 面向消息系统的生产级容灾编排（例如 Kafka 级别多活）

## 落地依赖条件

- 先冻结发布包结构与版本命名规范。
- 明确环境配置注入与密钥管理方式。
- 为关键链路建立可演练的恢复脚本与验收标准。

## 进入实现阶段触发条件

- 灾备目标（RPO/RTO）完成量化定义。
- 发布与回滚均可脚本化执行并验证。
- 至少完成一次“部署-故障-恢复”闭环演练。
