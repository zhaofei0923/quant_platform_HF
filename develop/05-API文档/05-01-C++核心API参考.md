# C++ 核心 API 参考

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地
- 证据路径：`include/quant_hft/`、`src/`、`tests/unit/core/`
- 最后更新：2026-02-11

## 概述

C++ 核心为本仓库提供交易相关的基础能力，包括：
- CTP 配置加载与网关适配（模拟/真实 API 受编译开关控制）
- 查询流控与调度（QueryScheduler）
- 基础风控、订单状态机、内存账本
- 本地 WAL 监管落地与回放恢复
- 存储抽象与适配（in-memory + 外部 Redis/Timescale 驱动）
- 策略桥接编解码与拉取（StrategyIntentCodec/StrategyIntentInbox）

对外头文件统一位于：`include/quant_hft/`。

## 1. 合约数据结构（include/quant_hft/contracts/types.h）

核心结构（节选）：
- `MarketSnapshot`
- `StateSnapshot7D` / `StateDimension`
- `SignalIntent`
- `OrderIntent` / `OrderEvent`
- `RiskDecision`
- `PositionSnapshot`
- `HealthEvent`

时间戳采用 `EpochNanos`（纳秒）。

## 2. 接口抽象（include/quant_hft/interfaces/*）

### 2.1 行情与交易网关

- `IMarketDataGateway`：连接、订阅与行情回调
  - 头文件：`include/quant_hft/interfaces/market_data_gateway.h`
- `IOrderGateway`：下单、撤单与订单事件回调
  - 头文件：`include/quant_hft/interfaces/order_gateway.h`

### 2.2 风控/状态/账本

- `IRiskEngine`：下单前风控
  - 头文件：`include/quant_hft/interfaces/risk_engine.h`
- `IMarketStateEngine`：状态快照生成与回调
  - 头文件：`include/quant_hft/interfaces/market_state_engine.h`
- `IPortfolioLedger`：账本更新与持仓快照
  - 头文件：`include/quant_hft/interfaces/portfolio_ledger.h`

### 2.3 数据层接口

- `IRealtimeCache`：实时快照读写
  - 头文件：`include/quant_hft/interfaces/realtime_cache.h`
- `ITimeseriesStore`：事件追加与查询
  - 头文件：`include/quant_hft/interfaces/timeseries_store.h`

### 2.4 合规模块接口

- `IRegulatorySink`：监管事件追加与刷盘
  - 头文件：`include/quant_hft/interfaces/regulatory_sink.h`

## 3. core 组件（include/quant_hft/core/*）

### 3.1 CTP 配置

- `CtpRuntimeConfig`、`CtpConfigValidator`
  - 头文件：`include/quant_hft/core/ctp_config.h`
- `CtpConfigLoader::LoadFromYaml(...)`
  - 头文件：`include/quant_hft/core/ctp_config_loader.h`

`ExecutionConfig`（`include/quant_hft/core/ctp_config.h`）当前关键字段：
- `mode`：`direct` / `sliced`
- `slice_size`：切片模式单次手数
- `slice_interval_ms`：切片间隔
- `cancel_after_ms`：超时撤单阈值（毫秒，`0` 表示关闭）
- `cancel_check_interval_ms`：撤单扫描周期（毫秒）

### 3.2 CTP 网关适配

- `CtpGatewayAdapter` 同时实现：`IMarketDataGateway` + `IOrderGateway`
  - 头文件：`include/quant_hft/core/ctp_gateway_adapter.h`

### 3.3 查询调度

- `QueryScheduler`：QPS 限流 + 优先级队列
  - 头文件：`include/quant_hft/core/query_scheduler.h`

### 3.4 WAL 回放恢复

- `WalReplayLoader`：从 WAL 重建订单状态机与账本
  - 头文件：`include/quant_hft/core/wal_replay_loader.h`

### 3.5 策略桥编解码与收件箱

- `StrategyIntentCodec`：`SignalIntent` 字符串编解码（`side/offset/trace_id` 等字段转换）
  - 头文件：`include/quant_hft/core/strategy_intent_codec.h`
- `StrategyIntentInbox`：读取 `strategy:intent:<strategy_id>:latest`，处理 `seq` 去重并输出批量意图
  - 头文件：`include/quant_hft/core/strategy_intent_inbox.h`

### 3.6 存储客户端工厂与外部驱动

- `StorageClientFactory`：根据连接配置创建 Redis/Timescale 客户端（in-memory/external）
  - 头文件：`include/quant_hft/core/storage_client_factory.h`
- `TcpRedisHashClient`：RESP over TCP 的 Redis Hash 客户端（`PING/HSET/HGETALL`）
  - 头文件：`include/quant_hft/core/tcp_redis_hash_client.h`
- `LibpqTimescaleSqlClient`：基于 `libpq` 的 Timescale SQL 客户端
  - 头文件：`include/quant_hft/core/libpq_timescale_sql_client.h`
- `TimescaleBufferedEventStore`：后台批量刷写包装器，降低同步写入阻塞
  - 头文件：`include/quant_hft/core/timescale_buffered_event_store.h`

## 4. services 组件（include/quant_hft/services/*）

- `BasicRiskEngine`
  - 头文件：`include/quant_hft/services/basic_risk_engine.h`
- `OrderStateMachine`
  - 头文件：`include/quant_hft/services/order_state_machine.h`
- `InMemoryOrderGateway`
  - 头文件：`include/quant_hft/services/in_memory_order_gateway.h`
- `InMemoryPortfolioLedger`
  - 头文件：`include/quant_hft/services/in_memory_portfolio_ledger.h`
- `RuleMarketStateEngine`
  - 头文件：`include/quant_hft/services/rule_market_state_engine.h`

## 5. 可执行程序

构建后默认输出到 `build/`：
- `build/core_engine`
- `build/simnow_probe`
- `build/wal_replay_tool`

## 6. 构建与链接

- 静态库目标：`quant_hft_core`（见 `CMakeLists.txt`）
- 常用构建：

```bash
cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
cmake --build build -j
ctest --test-dir build --output-on-failure
```
