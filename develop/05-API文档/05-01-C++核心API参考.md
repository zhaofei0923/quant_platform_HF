# C++ 核心 API 参考

## 对齐信息

- 对齐基线：f3a7252c342728920410b1148b40ea1a512f696d
- 最后更新：2026-02-11
- 变更范围：仅文档

## 概述

C++ 核心为本仓库提供交易相关的基础能力，包括：
- CTP 配置加载与网关适配（模拟/真实 API 受编译开关控制）
- 查询流控与调度（QueryScheduler）
- 基础风控、订单状态机、内存账本
- 本地 WAL 监管落地与回放恢复
- 存储抽象与适配（in-memory baseline + 外部驱动预备）

对外头文件统一位于：`include/quant_hft/`。

## 1. 合约数据结构（include/quant_hft/contracts/types.h）

核心结构（节选）：
- `MarketSnapshot`
- `StateSnapshot7D` / `StateDimension`
- `SignalIntent`
- `OrderIntent` / `OrderEvent`
- `RiskDecision`
- `PositionSnapshot`
- `HealthEvent`

时间戳采用 `EpochNanos`（纳秒）。

## 2. 接口抽象（include/quant_hft/interfaces/*）

### 2.1 行情与交易网关

- `IMarketDataGateway`：连接、订阅与行情回调
  - 头文件：`include/quant_hft/interfaces/market_data_gateway.h`
- `IOrderGateway`：下单、撤单与订单事件回调
  - 头文件：`include/quant_hft/interfaces/order_gateway.h`

### 2.2 风控/状态/账本

- `IRiskEngine`：下单前风控
  - 头文件：`include/quant_hft/interfaces/risk_engine.h`
- `IMarketStateEngine`：状态快照生成与回调
  - 头文件：`include/quant_hft/interfaces/market_state_engine.h`
- `IPortfolioLedger`：账本更新与持仓快照
  - 头文件：`include/quant_hft/interfaces/portfolio_ledger.h`

### 2.3 数据层接口

- `IRealtimeCache`：实时快照读写
  - 头文件：`include/quant_hft/interfaces/realtime_cache.h`
- `ITimeseriesStore`：事件追加与查询
  - 头文件：`include/quant_hft/interfaces/timeseries_store.h`

### 2.4 合规模块接口

- `IRegulatorySink`：监管事件追加与刷盘
  - 头文件：`include/quant_hft/interfaces/regulatory_sink.h`

## 3. core 组件（include/quant_hft/core/*）

### 3.1 CTP 配置

- `CtpRuntimeConfig`、`CtpConfigValidator`
  - 头文件：`include/quant_hft/core/ctp_config.h`
- `CtpConfigLoader::LoadFromYaml(...)`
  - 头文件：`include/quant_hft/core/ctp_config_loader.h`

### 3.2 CTP 网关适配

- `CtpGatewayAdapter` 同时实现：`IMarketDataGateway` + `IOrderGateway`
  - 头文件：`include/quant_hft/core/ctp_gateway_adapter.h`

### 3.3 查询调度

- `QueryScheduler`：QPS 限流 + 优先级队列
  - 头文件：`include/quant_hft/core/query_scheduler.h`

### 3.4 WAL 回放恢复

- `WalReplayLoader`：从 WAL 重建订单状态机与账本
  - 头文件：`include/quant_hft/core/wal_replay_loader.h`

## 4. services 组件（include/quant_hft/services/*）

- `BasicRiskEngine`
  - 头文件：`include/quant_hft/services/basic_risk_engine.h`
- `OrderStateMachine`
  - 头文件：`include/quant_hft/services/order_state_machine.h`
- `InMemoryOrderGateway`
  - 头文件：`include/quant_hft/services/in_memory_order_gateway.h`
- `InMemoryPortfolioLedger`
  - 头文件：`include/quant_hft/services/in_memory_portfolio_ledger.h`
- `RuleMarketStateEngine`
  - 头文件：`include/quant_hft/services/rule_market_state_engine.h`

## 5. 可执行程序

构建后默认输出到 `build/`：
- `build/core_engine`
- `build/simnow_probe`
- `build/wal_replay_tool`

## 6. 构建与链接

- 静态库目标：`quant_hft_core`（见 `CMakeLists.txt`）
- 常用构建：

```bash
cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
cmake --build build -j
ctest --test-dir build --output-on-failure
```
