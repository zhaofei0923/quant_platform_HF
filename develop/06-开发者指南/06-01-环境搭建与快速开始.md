# 环境搭建与快速开始

## 对齐信息

- 对齐基线：f3a7252c342728920410b1148b40ea1a512f696d
- 最后更新：2026-02-11
- 变更范围：仅文档

## 概述

本文档面向本仓库开发者，给出从零到“可构建、可运行、可验证”的最短路径。

说明：如需并行编写与维护文档，请参考 `develop/06-开发者指南/06-03-文档开发与多会话协作.md`。

## 1. 环境要求

- OS：Ubuntu 22.04 LTS（建议）
- CMake：>= 3.20
- C++：C++17（编译器支持即可）
- Python：>= 3.10

Ubuntu 依赖示例：

```bash
sudo apt-get update
sudo apt-get install -y build-essential cmake git python3 python3-venv
```

## 2. 一键构建与自测（推荐）

仓库提供一键脚本完成构建与质量门禁：

```bash
./scripts/build/bootstrap.sh
```

脚本会执行：
- C++：配置、编译、运行 `ctest`
- Python：创建 `.venv`、`pip install -e ".[dev]"`、`ruff/black/mypy/pytest`

如果你只想手动构建 C++：

```bash
cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
cmake --build build -j
ctest --test-dir build --output-on-failure
```

## 3. 运行 C++ 核心进程（core_engine）

使用 SimNow 配置运行：

```bash
export CTP_SIM_PASSWORD='your_password'
./build/core_engine configs/sim/ctp.yaml
```

可选配置（示例）：
- `configs/sim/ctp_trading_hours.yaml`
- `configs/dev/ctp.yaml`
- `configs/prod/ctp.yaml`

可选：在连接前做配置与网络预检：

```bash
.venv/bin/python scripts/ops/ctp_preflight_check.py --config configs/sim/ctp.yaml
```

## 4. Python 策略运行时（最小示例）

若已运行 `./scripts/build/bootstrap.sh`，则 `.venv` 已创建且依赖已安装。

最小策略示例（与 `python/tests/test_runtime_engine.py` 用法一致）：

```python
from quant_hft.contracts import OffsetFlag, OrderEvent, Side, SignalIntent, StateSnapshot7D
from quant_hft.runtime.engine import StrategyRuntime
from quant_hft.strategy.base import StrategyBase


class DemoStrategy(StrategyBase):
    def on_bar(self, ctx: dict[str, object], bar_batch: list[dict[str, object]]) -> list[SignalIntent]:
        return [
            SignalIntent(
                strategy_id=self.strategy_id,
                instrument_id="SHFE.ag2406",
                side=Side.BUY,
                offset=OffsetFlag.OPEN,
                volume=1,
                limit_price=4500.0,
                ts_ns=1,
                trace_id="t1",
            )
        ]

    def on_state(self, ctx: dict[str, object], state_snapshot: StateSnapshot7D) -> list[SignalIntent]:
        return []

    def on_order_event(self, ctx: dict[str, object], order_event: OrderEvent) -> None:
        ctx["events"] = int(ctx.get("events", 0)) + 1


runtime = StrategyRuntime()
runtime.add_strategy(DemoStrategy("demo"))
print(runtime.on_bar({}, [{"instrument_id": "SHFE.ag2406"}]))
```

## 5. 策略闭环演示（Redis Bridge）

该演示把 C++ `core_engine` 与 Python `StrategyRunner` 通过 Redis Hash 串成闭环：
- `core_engine` 发布 `market:state7d:<instrument>:latest`
- `StrategyRunner` 读取状态并写入 `strategy:intent:<strategy_id>:latest`
- `core_engine` 拉取策略信号，执行风控/下单，再写回 `trade:order:<trace_id>:info`

协议说明见：`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`。

### 5.1 启动 Redis

本地已有 Redis 时可跳过；示例（Docker）：

```bash
docker run --rm -p 6379:6379 redis:7-alpine
```

### 5.2 构建并运行 core_engine（外部 Redis 模式）

```bash
cmake -S . -B build \
  -DQUANT_HFT_BUILD_TESTS=ON \
  -DQUANT_HFT_ENABLE_REDIS_EXTERNAL=ON
cmake --build build -j

export CTP_SIM_PASSWORD='your_password'
export QUANT_HFT_REDIS_MODE=external
export QUANT_HFT_REDIS_HOST=127.0.0.1
export QUANT_HFT_REDIS_PORT=6379

./build/core_engine configs/sim/ctp.yaml --run-seconds 30
```

### 5.3 运行 Python 策略 runner

```bash
.venv/bin/python scripts/strategy/run_strategy.py \
  --config configs/sim/ctp.yaml \
  --strategy-id demo \
  --run-seconds 30
```

### 5.4 验证 Redis 关键键

```bash
redis-cli HGETALL market:state7d:SHFE.ag2406:latest
redis-cli HGETALL strategy:intent:demo:latest
```

## 6. 数据管道（可选）

单次运行：

```bash
.venv/bin/python scripts/data_pipeline/run_pipeline.py \
  --analytics-db runtime/analytics.duckdb \
  --export-dir runtime/exports \
  --archive-local-dir runtime/archive \
  --run-once
```
