# 代码结构与开发流程

## 对齐信息

- 对齐基线：f3a7252c342728920410b1148b40ea1a512f696d
- 最后更新：2026-02-11
- 变更范围：仅文档

## 概述

本文档提供本仓库的代码组织结构、构建与测试入口、以及建议的开发流程。

说明：如需并行编写与维护文档，请参考 `develop/06-开发者指南/06-03-文档开发与多会话协作.md`。

## 1. 仓库目录结构

```
quant_platform_HF/
├── src/                  # C++ 实现
│   ├── core/             # C++ 核心基础组件
│   │   ├── ctp/          # CTP 配置与网关适配
│   │   ├── regulatory/   # 本地 WAL 监管落地与回放
│   │   ├── storage/      # 存储适配（in-memory + 外部驱动预备）
│   │   └── common/       # 通用工具
│   ├── services/         # C++ 领域服务
│   │   ├── market_state/ # 规则市场状态引擎
│   │   ├── order/        # 订单状态机与网关
│   │   ├── portfolio/    # 内存账本
│   │   └── risk/         # 基础风控
│   └── apps/             # 可执行程序入口（main）
├── include/quant_hft/     # C++ 公共头文件（对外接口）
│   ├── contracts/         # 领域数据结构
│   ├── interfaces/        # 接口抽象
│   ├── core/              # core 组件头文件
│   └── services/          # services 组件头文件
├── python/quant_hft/       # Python runtime/tooling
│   ├── strategy/          # 策略接口
│   ├── runtime/           # 运行时调度
│   ├── backtest/          # 回测回放工具
│   ├── data_pipeline/     # 数据管道
│   └── ops/               # 运维脚本库（渲染/验证/报告）
├── scripts/               # 命令行脚本入口
├── configs/               # CTP 配置（dev/sim/prod）
├── proto/                 # Protobuf 合约（版本化）
├── tests/unit/            # C++ 单元测试（GTest）
├── python/tests/          # Python 单元测试（pytest）
├── docs/                  # runbook/验收/进度
└── develop/               # 设计与开发文档
```

## 2. 构建、测试与质量门禁

### 2.1 一键入口（推荐）

```bash
./scripts/build/bootstrap.sh
```

### 2.2 C++（手动）

```bash
cmake -S . -B build -DQUANT_HFT_BUILD_TESTS=ON
cmake --build build -j
ctest --test-dir build --output-on-failure
```

### 2.3 Python（手动）

```bash
python3 -m venv .venv
.venv/bin/pip install --upgrade pip
.venv/bin/pip install -e ".[dev]"

.venv/bin/ruff check python scripts
.venv/bin/black --check python scripts
.venv/bin/mypy python/quant_hft
.venv/bin/pytest python/tests -q
```

### 2.4 CI 对齐

CI 以 `.github/workflows/ci.yml` 为准，默认包含：
- C++：cmake/build/ctest
- Python：ruff/black/mypy/pytest

## 3. 建议开发流程

### 3.1 小步提交

- 单次提交尽量只解决一个问题
- 先写或补齐测试，再实现/修改
- 变更涉及文档时，同步更新 `develop/` 或 `docs/`

### 3.2 变更自检

- 代码变更：必须在本地通过 `./scripts/build/bootstrap.sh`
- 文档变更：
  - 路径真实存在
  - 命令可执行（至少在开发环境跑通）
  - 记录对齐基线与更新日期

## 4. 常用定位命令

```bash
# 在仓库中快速定位符号或关键字
rg -n "CtpGatewayAdapter" -S .

# 列出仓库文件（用于校验文档里路径是否存在）
rg --files | rg "^develop/"
```
