# 运维操作手册

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`scripts/ops/ctp_preflight_check.py`、`scripts/ops/run_reconnect_evidence.py`、`scripts/ops/verify_wal_recovery_evidence.py`、`scripts/ops/verify_deploy_rollback_evidence.py`、`scripts/ops/failover_orchestrator.py`、`scripts/ops/verify_failover_evidence.py`、`scripts/infra/bootstrap_prodlike_multi_host.sh`、`docs/WAL_RECOVERY_RUNBOOK.md`、`docs/templates/WAL_RECOVERY_RESULT.md`、`docs/templates/DEPLOY_ROLLBACK_RESULT.md`
- 最后更新：2026-02-11

## 当前实现边界

当前仓库可直接执行的运维操作聚焦在“单机/小规模验证”与“演练工具”：
- CTP 预检、重连证据、SLO 报告脚本。
- WAL 恢复 runbook。
- systemd/k8s（非热路径）部署渲染工具。

面向完整生产集群的章节（大规模集群操作、统一监控平台、跨集群容灾）在当前基线作为可选扩展内容维护。
当前生产验收口径：单机生产环境（单台 PC 或云上单实例主机）先完成全流程验收；仓库内已提供多机主备切换演练入口（默认 dry-run），多活容灾仍属后续批次。

## 现状 SOP（已落地，可执行）

### 1. 部署前预检

```bash
.venv/bin/python scripts/ops/ctp_preflight_check.py --config configs/sim/ctp.yaml
```

### 2. 重连演练与证据归档

```bash
.venv/bin/python scripts/ops/run_reconnect_evidence.py \
  --config configs/sim/ctp.yaml \
  --report-file docs/results/reconnect_fault_result.md \
  --health-json-file docs/results/ops_health_report.json \
  --health-markdown-file docs/results/ops_health_report.md
```

### 3. SLO 报告生成

```bash
.venv/bin/python scripts/ops/reconnect_slo_report.py \
  --fault-events-file runtime/fault_events.jsonl \
  --probe-log-file runtime/reconnect_probe.log \
  --output-file docs/results/reconnect_fault_result.md \
  --health-json-file docs/results/ops_health_report.json \
  --health-markdown-file docs/results/ops_health_report.md
```

### 4. WAL 恢复参考

- 执行步骤：`docs/WAL_RECOVERY_RUNBOOK.md`
- 演练证据模板：`docs/templates/WAL_RECOVERY_RESULT.md`
- 演练证据校验：

```bash
.venv/bin/python scripts/ops/verify_wal_recovery_evidence.py \
  --evidence-file docs/results/wal_recovery_result.env \
  --max-rto-seconds 10 \
  --max-rpo-events 0
```

### 5. 部署/回滚演练证据校验

- 演练证据模板：`docs/templates/DEPLOY_ROLLBACK_RESULT.md`

```bash
.venv/bin/python scripts/ops/verify_deploy_rollback_evidence.py \
  --evidence-file docs/results/deploy_rollback_result.env \
  --max-rollback-seconds 180
```

### 6. 仓库内部署编排入口（dry-run）

```bash
.venv/bin/python scripts/ops/rollout_orchestrator.py \
  --env-config configs/deploy/environments/sim.yaml \
  --inject-fault \
  --output-file docs/results/rollout_result.env

.venv/bin/python scripts/ops/verify_rollout_evidence.py \
  --evidence-file docs/results/rollout_result.env \
  --require-fault-step
```

### 7. 单机生产环境验收流程（当前）

```bash
bash scripts/infra/bootstrap_prodlike.sh --execute --action up
python3 scripts/infra/check_prodlike_health.py --report-json docs/results/prodlike_health_report.json
python3 scripts/ops/rollout_orchestrator.py --execute --env-config configs/deploy/environments/staging.yaml --inject-fault --output-file docs/results/rollout_result.env
python3 scripts/ops/verify_rollout_evidence.py --evidence-file docs/results/rollout_result.env --require-fault-step
```

### 8. 多机主备切换演练流程（仓库范围）

```bash
bash scripts/infra/bootstrap_prodlike_multi_host.sh --dry-run --action up --output-file docs/results/prodlike_multi_host_bootstrap_result.env
python3 scripts/ops/failover_orchestrator.py --env-config configs/deploy/environments/prodlike_multi_host.yaml --output-file docs/results/failover_result.env
python3 scripts/ops/verify_failover_evidence.py --evidence-file docs/results/failover_result.env --max-failover-seconds 300 --max-data-lag-events 0
```

## 扩展 SOP（可选）

以下内容仅保留为未来目标示例，不可视作当前可执行手册：
- `kubernetes/production` 全量集群操作
- `helm/` 发布体系
- 企业级统一监控、追踪与消息平台
- 双机/多机主备切换与跨主机容灾编排

## 落地依赖条件

- 需要先明确生产环境拓扑和角色职责。
- 需要建立值班告警分级与响应时限。
- 需要为关键组件提供稳定演练环境。

## 扩展实施触发条件

- 生产环境验收标准明确（可用性、恢复时限、审计要求）。
- 运维流程可脚本化并纳入版本管理。
- 每条 SOP 至少有一次演练证据闭环。
