# 运维操作手册

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：部分落地
- 证据路径：`scripts/ops/ctp_preflight_check.py`、`scripts/ops/run_reconnect_evidence.py`、`scripts/ops/verify_wal_recovery_evidence.py`、`docs/WAL_RECOVERY_RUNBOOK.md`、`docs/templates/WAL_RECOVERY_RESULT.md`
- 最后更新：2026-02-11

## 当前实现边界

当前仓库可直接执行的运维操作聚焦在“单机/小规模验证”与“演练工具”：
- CTP 预检、重连证据、SLO 报告脚本。
- WAL 恢复 runbook。
- systemd/k8s（非热路径）部署渲染工具。

原先面向完整生产集群的章节（大规模集群操作、统一监控平台、跨集群容灾）在当前基线均属于规划内容。

## 现状 SOP（已落地，可执行）

### 1. 部署前预检

```bash
.venv/bin/python scripts/ops/ctp_preflight_check.py --config configs/sim/ctp.yaml
```

### 2. 重连演练与证据归档

```bash
.venv/bin/python scripts/ops/run_reconnect_evidence.py \
  --config configs/sim/ctp.yaml \
  --report-file docs/results/reconnect_fault_result.md \
  --health-json-file docs/results/ops_health_report.json \
  --health-markdown-file docs/results/ops_health_report.md
```

### 3. SLO 报告生成

```bash
.venv/bin/python scripts/ops/reconnect_slo_report.py \
  --fault-events-file runtime/fault_events.jsonl \
  --probe-log-file runtime/reconnect_probe.log \
  --output-file docs/results/reconnect_fault_result.md \
  --health-json-file docs/results/ops_health_report.json \
  --health-markdown-file docs/results/ops_health_report.md
```

### 4. WAL 恢复参考

- 执行步骤：`docs/WAL_RECOVERY_RUNBOOK.md`
- 演练证据模板：`docs/templates/WAL_RECOVERY_RESULT.md`
- 演练证据校验：

```bash
.venv/bin/python scripts/ops/verify_wal_recovery_evidence.py \
  --evidence-file docs/results/wal_recovery_result.env \
  --max-rto-seconds 10 \
  --max-rpo-events 0
```

## 规划示例（未落地）

## 规划 SOP（未落地）

以下内容仅保留为未来目标示例，不可视作当前可执行手册：
- `kubernetes/production` 全量集群操作
- `helm/` 发布体系
- 企业级统一监控、追踪与消息平台

## 落地依赖条件

- 需要先明确生产环境拓扑和角色职责。
- 需要建立值班告警分级与响应时限。
- 需要为关键组件提供稳定演练环境。

## 进入实现阶段触发条件

- 生产环境验收标准明确（可用性、恢复时限、审计要求）。
- 运维流程可脚本化并纳入版本管理。
- 每条 SOP 至少有一次演练证据闭环。
