# 数据库设计

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：已落地（仓库范围）
- 证据路径：`src/core/storage/`、`include/quant_hft/core/`、`python/quant_hft/data_pipeline/adapters.py`、`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`、`infra/timescale/init/001_quant_hft_schema.sql`、`scripts/infra/init_timescale_schema.sh`
- 最后更新：2026-02-11

## 0. 本轮变更摘要（2026-02-11）

1. Timescale 逻辑表由 3 张扩展为 7 张：
   - 原有：`market_snapshots`、`order_events`、`risk_decisions`
   - 新增：`ctp_trading_accounts`、`ctp_investor_positions`、`ctp_instrument_meta`、`ctp_broker_trading_params`
2. CTP 扩展字段完成落表与回读：
   - `market_snapshots`：`exchange_id/trading_day/action_day/update_time/update_millisec/settlement_price/average_price_raw/average_price_norm/is_valid_settlement`
   - `order_events`：`exchange_id/status_msg/order_submit_status/order_ref/front_id/session_id/trade_id/event_source`
3. 迁移脚本与初始化脚本均支持幂等：
   - 迁移：`infra/timescale/init/002_ctp_account_position_schema.sql`
   - 初始化：`scripts/infra/init_timescale_schema.sh`
4. CTP readiness 证据链脚本已提供：
   - `scripts/ops/run_ctp_readiness_evidence.py`
   - 当前示例产物：`docs/results/ctp_readiness_2026-02-11.json`（参数化样本）
   - 生产验收建议：盘中使用实时采集指标重跑该脚本并归档证据。

## 1. 当前实现边界

当前代码已落地“实时缓存 + 时序事件 + 分析归档适配”的基础形态：
- C++ 侧实时缓存：`RedisRealtimeStore` / `RedisRealtimeStoreClientAdapter`
- C++ 侧时序存储：`TimescaleEventStore*` / `TimescaleBufferedEventStore`
- 外部驱动：`TcpRedisHashClient`、`LibpqTimescaleSqlClient`
- Python 数据侧：`DuckDbAnalyticsStore`、`MinioArchiveStore`、`DataPipelineProcess`

扩展边界：完整企业级数仓建模、全自动生命周期治理、生产级多活容灾。
当前生产验收口径：先完成单机或单区域环境的数据一致性与恢复验证；跨主机备份与跨区域容灾在后续批次推进。

## 2. 已落地 Redis 键与字段映射

### 2.1 C++ realtime cache

- `market:tick:<instrument_id>:latest`
- `market:state7d:<instrument_id>:latest`
- `trade:order:<client_order_id>:info`
- `trade:position:<account_id>:<instrument_id>:<direction>`

主要映射代码：
- `src/core/storage/redis_realtime_store.cpp`
- `src/core/storage/redis_realtime_store_client_adapter.cpp`

### 2.2 策略桥约定

- 状态键：`market:state7d:<instrument_id>:latest`
- 意图键：`strategy:intent:<strategy_id>:latest`
- 回报键：`trade:order:<trace_id>:info`

协议文档：`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`

## 3. 已落地 Timescale 行表映射

`TimescaleEventStoreClientAdapter` 当前写入七张逻辑表：
- `market_snapshots`
- `order_events`
- `risk_decisions`
- `ctp_trading_accounts`
- `ctp_investor_positions`
- `ctp_instrument_meta`
- `ctp_broker_trading_params`

对应代码：`src/core/storage/timescale_event_store_client_adapter.cpp`

表结构与初始化脚本（Ubuntu 目标机）：
- SQL：`infra/timescale/init/001_quant_hft_schema.sql`
- 初始化脚本：`scripts/infra/init_timescale_schema.sh`
- 入口编排：`scripts/infra/bootstrap_prodlike.sh`（`up` 动作会串行执行 compose up -> schema init -> health check）

已落地逻辑表（与 C++ 映射一致）：
- `market_snapshots`
- `order_events`
- `risk_decisions`
- `ctp_trading_accounts`
- `ctp_investor_positions`
- `ctp_instrument_meta`
- `ctp_broker_trading_params`

### 3.1 Ubuntu 落地建议（生产口径）

1. 使用 Ubuntu 原生 Docker Engine（`docker-ce` + compose plugin），不依赖 Docker Desktop。
2. `timescale-primary` 通过 compose 挂载 `docker-entrypoint-initdb.d` 初始化 SQL，并由 `init_timescale_schema.sh` 做幂等补齐与校验。
3. 编译核心服务时开启外部存储驱动：
   - `-DQUANT_HFT_ENABLE_REDIS_EXTERNAL=ON`
   - `-DQUANT_HFT_ENABLE_TIMESCALE_EXTERNAL=ON`
4. 运行时使用 external 模式并关闭 fallback（避免误落到 in-memory）：
   - `QUANT_HFT_REDIS_MODE=external`
   - `QUANT_HFT_TIMESCALE_MODE=external`
   - `QUANT_HFT_STORAGE_ALLOW_FALLBACK=false`

## 4. 客户端与连接管理

### 4.1 已落地

- `StorageConnectionConfig`：统一连接参数读取与环境变量覆盖。
- `StorageClientFactory`：in-memory/external 客户端创建策略。
- `StorageClientPool`：客户端池化与重试。
- `Ping()` 健康检查：`IRedisHashClient`、`ITimescaleSqlClient`。

### 4.2 外部驱动

- Redis：`TcpRedisHashClient`（RESP over TCP，支持 `PING/HSET/HGETALL`、可选 `AUTH`）。
- Timescale：`LibpqTimescaleSqlClient`（运行时动态加载 `libpq`，支持插入与查询）。

## 5. Python 分析与归档层（已落地）

- `DuckDbAnalyticsStore`：分析表写入、查询、CSV 导出。
- `MinioArchiveStore`：对象归档（支持本地 fallback）。
- `DataPipelineProcess`：批次处理与导出清单。

主要路径：
- `python/quant_hft/data_pipeline/adapters.py`
- `python/quant_hft/data_pipeline/process.py`
- `scripts/data_pipeline/run_pipeline.py`

## 6. 能力扩展与当前实现

1. 数据生命周期全自动策略（冷热分层、归档回迁自动化）。
2. 研究数仓统一模型与元数据治理。
3. 跨区域灾备与一致性对账自动化。

## 7. 落地依赖条件

- 冻结交易与研究数据字典，统一字段语义。
- 明确外部数据库实例规格、权限与备份策略。
- 建立端到端数据完整性验收脚本。

## 8. 扩展实施触发条件

- 需求明确指向具体存储层与数据对象。
- 每项新增映射都有回归测试与迁移方案。
- 更新文档状态前提供可执行命令与证据路径。
