# 数据库设计

## 对齐信息

- 对齐基线：main@f1f98c884be1538c06acff265f2904745175be96
- 实现状态：已落地（仓库范围）
- 证据路径：`src/core/storage/`、`include/quant_hft/core/`、`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`、`infra/timescale/init/001_quant_hft_schema.sql`、`scripts/infra/init_timescale_schema.sh`
- 最后更新：2026-02-17

## 1. 当前实现边界

当前代码已落地“实时缓存 + 时序事件 + 合规回放”基础形态：
- C++ 侧实时缓存：`RedisRealtimeStore` / `RedisRealtimeStoreClientAdapter`
- C++ 侧时序存储：`TimescaleEventStore*` / `TimescaleBufferedEventStore`
- 外部驱动：`TcpRedisHashClient`、`LibpqTimescaleSqlClient`
- 合规恢复：`LocalWalRegulatorySink` + `wal_replay_tool`

## 2. Redis 键与字段映射

### 2.1 Realtime cache

- `market:tick:<instrument_id>:latest`
- `market:state7d:<instrument_id>:latest`
- `trade:order:<client_order_id>:info`
- `trade:position:<account_id>:<instrument_id>:<direction>`

主要映射代码：
- `src/core/storage/redis_realtime_store.cpp`
- `src/core/storage/redis_realtime_store_client_adapter.cpp`

### 2.2 策略事件约定

- 状态键：`market:state7d:<instrument_id>:latest`
- 意图键：`strategy:intent:<strategy_id>:latest`
- 回报键：`trade:order:<trace_id>:info`

协议文档：`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`

## 3. Timescale 行表映射

`TimescaleEventStoreClientAdapter` 当前写入七张逻辑表：
- `market_snapshots`
- `order_events`
- `risk_decisions`
- `ctp_trading_accounts`
- `ctp_investor_positions`
- `ctp_instrument_meta`
- `ctp_broker_trading_params`

对应代码：`src/core/storage/timescale_event_store_client_adapter.cpp`

## 4. 客户端与连接管理

- `StorageConnectionConfig`：统一连接参数与环境变量覆盖。
- `StorageClientFactory`：in-memory/external 客户端创建策略。
- `StorageClientPool`：客户端池化与重试。
- `Ping()`：Redis 与 Timescale 健康检查。

## 5. 运维入口

- Schema 初始化：`bash scripts/infra/init_timescale_schema.sh`
- 单机依赖栈：`bash scripts/infra/bootstrap_prodlike.sh --execute --action up`
- 多机依赖栈：`bash scripts/infra/bootstrap_prodlike_multi_host.sh --dry-run --action up`

## 6. 能力扩展与当前实现

1. 数据生命周期自动分层策略。
2. 跨区域灾备与一致性对账自动化。
3. 高并发写入下的容量与归档治理。
