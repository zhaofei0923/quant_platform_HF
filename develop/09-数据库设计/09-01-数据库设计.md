# 数据库设计

## 对齐信息

- 对齐基线：main@17f0f8c957a4c0f95ebb054725f04b21e0e6861b
- 实现状态：部分落地
- 证据路径：`src/core/storage/`、`include/quant_hft/core/`、`python/quant_hft/data_pipeline/adapters.py`、`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`
- 最后更新：2026-02-11

## 1. 当前实现边界

当前代码已落地“实时缓存 + 时序事件 + 分析归档适配”的基础形态：
- C++ 侧实时缓存：`RedisRealtimeStore` / `RedisRealtimeStoreClientAdapter`
- C++ 侧时序存储：`TimescaleEventStore*` / `TimescaleBufferedEventStore`
- 外部驱动：`TcpRedisHashClient`、`LibpqTimescaleSqlClient`
- Python 数据侧：`DuckDbAnalyticsStore`、`MinioArchiveStore`、`DataPipelineProcess`

未落地内容：完整企业级数仓建模、全自动生命周期治理、生产级多活容灾。

## 2. 已落地 Redis 键与字段映射

### 2.1 C++ realtime cache

- `market:tick:<instrument_id>:latest`
- `market:state7d:<instrument_id>:latest`
- `trade:order:<client_order_id>:info`
- `trade:position:<account_id>:<instrument_id>:<direction>`

主要映射代码：
- `src/core/storage/redis_realtime_store.cpp`
- `src/core/storage/redis_realtime_store_client_adapter.cpp`

### 2.2 策略桥约定

- 状态键：`market:state7d:<instrument_id>:latest`
- 意图键：`strategy:intent:<strategy_id>:latest`
- 回报键：`trade:order:<trace_id>:info`

协议文档：`docs/STRATEGY_BRIDGE_REDIS_PROTOCOL.md`

## 3. 已落地 Timescale 行表映射

`TimescaleEventStoreClientAdapter` 当前写入三张逻辑表：
- `market_snapshots`
- `order_events`
- `risk_decisions`

对应代码：`src/core/storage/timescale_event_store_client_adapter.cpp`

说明：表结构与创建策略由具体 `ITimescaleSqlClient` 实现和部署侧初始化流程共同决定，当前仓库重点在“字段映射与写入重试语义”。

## 4. 客户端与连接管理

### 4.1 已落地

- `StorageConnectionConfig`：统一连接参数读取与环境变量覆盖。
- `StorageClientFactory`：in-memory/external 客户端创建策略。
- `StorageClientPool`：客户端池化与重试。
- `Ping()` 健康检查：`IRedisHashClient`、`ITimescaleSqlClient`。

### 4.2 外部驱动

- Redis：`TcpRedisHashClient`（RESP over TCP，支持 `PING/HSET/HGETALL`、可选 `AUTH`）。
- Timescale：`LibpqTimescaleSqlClient`（运行时动态加载 `libpq`，支持插入与查询）。

## 5. Python 分析与归档层（已落地）

- `DuckDbAnalyticsStore`：分析表写入、查询、CSV 导出。
- `MinioArchiveStore`：对象归档（支持本地 fallback）。
- `DataPipelineProcess`：批次处理与导出清单。

主要路径：
- `python/quant_hft/data_pipeline/adapters.py`
- `python/quant_hft/data_pipeline/process.py`
- `scripts/data_pipeline/run_pipeline.py`

## 6. 规划内容（未落地）

1. 数据生命周期全自动策略（冷热分层、归档回迁自动化）。
2. 研究数仓统一模型与元数据治理。
3. 跨区域灾备与一致性对账自动化。

## 7. 落地依赖条件

- 冻结交易与研究数据字典，统一字段语义。
- 明确外部数据库实例规格、权限与备份策略。
- 建立端到端数据完整性验收脚本。

## 8. 进入实现阶段触发条件

- 需求明确指向具体存储层与数据对象。
- 每项新增映射都有回归测试与迁移方案。
- 更新文档状态前提供可执行命令与证据路径。
