TIMESCALE_SCHEMA_INIT_DRY_RUN=0
TIMESCALE_SCHEMA_INIT_SUCCESS=true
TIMESCALE_SCHEMA_INIT_FAILED_STEP=
TIMESCALE_SCHEMA_INIT_COMPOSE_FILE=infra/docker-compose.single-host.yaml
TIMESCALE_SCHEMA_INIT_PROJECT_NAME=quant-hft-single-host
TIMESCALE_SCHEMA_INIT_ENV_FILE=infra/env/prodlike.env
TIMESCALE_SCHEMA_INIT_SCHEMA_FILE=
TIMESCALE_SCHEMA_INIT_SCHEMA_DIR=infra/timescale/init
TIMESCALE_SCHEMA_INIT_SCHEMA_FILE_COUNT=6
TIMESCALE_SCHEMA_INIT_EXPECTED_TABLE_COUNT=20
TIMESCALE_SCHEMA_INIT_SERVICE=timescale-primary
TIMESCALE_SCHEMA_INIT_DB=quant_hft
TIMESCALE_SCHEMA_INIT_USER=quant_hft
TIMESCALE_SCHEMA_INIT_READY_TIMEOUT_SEC=120
TIMESCALE_SCHEMA_INIT_READY_POLL_INTERVAL_SEC=2
TIMESCALE_SCHEMA_INIT_APPLY_MAX_ATTEMPTS=20
TIMESCALE_SCHEMA_INIT_APPLY_RETRY_INTERVAL_SEC=2
TIMESCALE_SCHEMA_INIT_TOTAL_STEPS=3
STEP_1_NAME=wait_ready
STEP_1_STATUS=ok
STEP_1_DURATION_MS=135
STEP_1_COMMAND=docker compose -f infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env exec -T timescale-primary pg_isready -U quant_hft -d quant_hft (timeout=120s interval=2s)
STEP_2_NAME=apply_schema
STEP_2_STATUS=ok
STEP_2_DURATION_MS=862
STEP_2_COMMAND=docker compose -f infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env exec -T timescale-primary psql -v ON_ERROR_STOP=1 -U quant_hft -d quant_hft < <schema-files> (files=6 retry=20x interval=2s)
STEP_3_NAME=verify_schema
STEP_3_STATUS=ok
STEP_3_DURATION_MS=148
STEP_3_COMMAND=docker compose -f infra/docker-compose.single-host.yaml --project-name quant-hft-single-host --env-file infra/env/prodlike.env exec -T timescale-primary psql -t -A -U quant_hft -d quant_hft -c "WITH required(schema_name, table_name) AS (
    VALUES
        ('analytics_ts', 'market_snapshots'),
        ('analytics_ts', 'order_events'),
        ('analytics_ts', 'risk_decisions'),
        ('trading_core', 'account_funds'),
        ('trading_core', 'position_detail'),
        ('trading_core', 'position_summary'),
        ('trading_core', 'orders'),
        ('trading_core', 'trades'),
        ('trading_core', 'instruments'),
        ('trading_core', 'trading_calendar'),
        ('trading_core', 'strategies'),
        ('trading_core', 'strategy_params'),
        ('trading_core', 'risk_events'),
        ('trading_core', 'fund_transfer'),
        ('trading_core', 'fee_margin_template'),
        ('ops', 'system_config'),
        ('ops', 'system_logs'),
        ('ops', 'archive_manifest'),
        ('ops', 'sim_account_mapping'),
        ('ops', 'ctp_connection')
)
SELECT COUNT(*)
FROM required r
JOIN information_schema.tables t
  ON t.table_schema = r.schema_name
 AND t.table_name = r.table_name;" (retry=20x interval=2s)
